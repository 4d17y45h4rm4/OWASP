# Testing for Format String

## Summary

A format string is a null-terminated character sequence that also contains conversion specifiers interpreted or converted at runtime.  If server-side code [concatenates a user's input with a format string](https://www.netsparker.com/blog/web-security/string-concatenation-format-string-vulnerabilities/), an attacker can append additional conversion specifications to cause a runtime error, information disclosure, or buffer overflow.

The worst case for format strings vulnerabilities occur in languages that don't check arguments and also include a `%n` specifier that writes to memory. These functions, if exploited by an attacker modifying a format string, could cause [information disclosure and code execution](https://www.veracode.com/security/format-string):

* C and C++ [printf](https://en.cppreference.com/w/c/io/fprintf) and similar methods fprintf, sprintf, snprintf
* Perl [printf](https://perldoc.perl.org/functions/printf.html) and sprintf

These format string functions can't write to memory, but attackers can still cause information disclosure by changing format strings to output values the developers did not intend to send:

* Python 2.6 and 2.7's [str.format](https://docs.python.org/2/library/string.html) and Python 3's unicode [str.format](https://docs.python.org/3/library/stdtypes.html#str.format) can be modified by injecting strings that can point to [other variables](https://lucumr.pocoo.org/2016/12/29/careful-with-str-format/) in memory

The following format strings if modified can cause runtime errors if the attacker adds conversion specifier:

* Java [String.format](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/String.html#format(java.lang.String,java.lang.Object...)) and [PrintStream.format](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/io/PrintStream.html#format(java.util.Locale,java.lang.String,java.lang.Object...))
* PHP's [printf](https://www.php.net/manual/es/function.printf.php)

The code pattern that causes a format string vulnerability is usually an append or concatenate inside the an argument passed to a format string. A direct example for Java is as follows:

```java
final String userName = /* input from user controlled field */;
final int numCredits = /* input from some datastore call */;

// Vulnerable code:
final String outputGreeting = String.format(userName + " has %d credits", numCredits);
// ...send that outputGreeting to the rest of the app
```

In this particular example, if the attacker set their _userName_ to `%s`, `%d`, or any one of Java's specifiers that require an input, the application would crash. Attacks in other languages work in the same way, in which the attacker adds specifiers to cause undesired behaviour.

## Test Objectives

Assess whether injecting format string conversion specifiers into user-controlled fields can cause undesired behaviour from the web application.

## How to Test

### Static Analysis

Static analysis tools can find format string vulnerabilities in either the code or in binaries. Examples of tools include:

* C and C++: [Flawfinder](https://dwheeler.com/flawfinder/)  
* Java: FindSecurityBugs rule [FORMAT_STRING_MANIPULATION](https://find-sec-bugs.github.io/bugs.htm#FORMAT_STRING_MANIPULATION)
* PHP: String formatter Analyzer in [phpsa](https://github.com/ovr/phpsa/blob/master/docs/05_Analyzers.md#function_string_formater)

### Manual Code Inspection

Static analysis may miss more subtle cases including format strings come from complex code. To look for vulnerabilities manually in a codebase, a tester can look for all calls in the codebase that accept a format string and trace back to make sure untrusted input cannot change the format string.

### Format Specifier Injection

Testers can check at the unit test or full system test level by sending format specifiers in any string input. [Fuzz](https://owasp.org/www-community/Fuzzing) the program using all of the format specifiers for all languages the system under test uses. See the [OWASP Format string attack](https://owasp.org/www-community/attacks/Format_string_attack) page for possible inputs to use. If the test fails, the program will crash or display an unexpected output. If the test passes, the attempt to send a format specifier should be blocked, or the string should go through the system with no issues as with any other valid input.
